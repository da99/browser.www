#!/usr/bin/env bash
#
#
THE_ARGS="$@"
THIS_DIR="$(bash_setup dirname_of_bin "$0")"
PORT=${PORT:-"4567"}

export PORT
TEMP="/tmp/dum_dum_js"
TEMP_DIR=${TEMP_DIR:-"/temp/dum_dum_js"}
TEMP_SPLITS="$TEMP/splits"
export TEMP_DIR
mkdir -p $TEMP_SPLITS
mkdir -p $TEMP

if [[ -z "$@" ]]; then
  action="watch"
else
  action=$1
  shift
fi

set -u -e -o pipefail


Color_Off='\e[0m'
Bold="$(tput bold)"
Reset='\e[0m'
BRed='\e[1;31m'
Red='\e[0;31m'
Green='\e[0;32m'
BGreen='\e[1;32m'
Orange='\e[0;33m'
BOrange='\e[1;33m'



case $action in
  help|--help)
    bash_setup print_help $0
    ;;

  *)
    # === IF: Run bin/lib file:
    func_file="$THIS_DIR/bin/lib/${action}.sh"
    if [[ -s "$func_file" ]]; then
      source "$func_file"
      "$action" $@
      exit 0
    fi

    # === IF: Compile HTML file:
    if [[ -f "$action" && "$action" == *.html ]]; then
      node $THIS_DIR/main/main.js $THE_ARGS
      # TODO: remove duplicate nodes: link, src, meta
      # vnu="$(echo tmp/validator/*/dist/vnu.jar)"
      # final="$(node $THIS_DIR/main/main.js $THE_ARGS)"

      # # === If <body is found, validate whole document:
      # if echo "$final" | grep -i '<body' &>/dev/null; then
      #   echo "$final" | java -jar "$vnu" - || { stat="$?"; echo $action 1>&2; exit $stat; }
      # fi

      # echo "$final"
      exit 0
    fi

    # === It's an error:
    echo "!!! Unknown action: $action" 1>&2
    exit 1
    ;;
esac
