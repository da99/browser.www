#!/usr/bin/env bash
#
#
THE_ARGS="$@"
THIS_DIR="$(bash_setup dirname_of_bin "$0")"

if [[ -z "$@" ]]; then
  action="watch"
else
  action=$1
  shift
fi

set -u -e -o pipefail

Color_Off='\e[0m'
Bold="$(tput bold)"
Reset='\e[0m'
BRed='\e[1;31m'
Red='\e[0;31m'
Green='\e[0;32m'
BGreen='\e[1;32m'
Orange='\e[0;33m'
BOrange='\e[1;33m'

case $action in
  help|--help)
    echo "=== dum_dum_html  files # Order is irrelevant. Include layout files and templates."
    bash_setup print_help $0
    ;;

  install_validator)
    cd "$THIS_DIR"
    mkdir -p tmp/validator
    cd tmp/validator
    rm -rf dist
    zip_url="$(wget -qO-  https://api.github.com/repos/validator/validator/releases/latest | grep browser_ | cut -d\" -f4 | head -n 1)"
    file_name="$(basename "$zip_url")"
    dir_name="$(basename "$zip_url" ".zip")"
    if [[ -d "$dir_name" ]]; then
      echo "=== Already installed vnu: $dir_name"
      exit 0
    fi
    trash-put vnu.jar* || : # Remove old files/dirs because they take lots of space.
    wget "$zip_url"
    unzip "$file_name" -d "$dir_name"
    ;;

  upgrade)
    # === upgrade
    $0 install_validator

    cd "$THIS_DIR"
    js_setup upgrade
    ;;

  watch)
    bash_setup is_same_file "$0" || :
    # === watch
    cmd () {
      path="$1"; shift
      js_setup   jshint "$path" && { bash_setup is_same_file "$path" || : ; }
    }

    failed=""
    for FILE in main/*.js; do
      cmd "$FILE" || failed="yes"
    done
    if [[ -z "$failed" ]]; then
      $0 test || :
    fi

    echo -e "\n=== Watching:"
    while read -r CHANGE; do
      dir=$(echo "$CHANGE" | cut -d' ' -f 1)
      path="${dir}$(echo "$CHANGE" | cut -d' ' -f 3)"
      file="$(basename $path)"

      # Make sure this is not a temp/swap file:
      { [[ ! -f "$path" ]] && continue; } || :

      # Check if file has changed:
      if bash_setup is_same_file "$path"; then
        echo "=== No change: $CHANGE"
        continue
      fi

      # File has changed:
      echo -e "\n=== $CHANGE ($path)"
      if [[ "$path" =~ "$0" ]]; then
        echo "=== Reloading..."
        break
      fi

      if [[ "$file" =~ ".js" ]]; then
        cmd $path || continue
      fi

      if [[ "$file" =~ "main.js" ]]; then
        $0 test || continue
      fi

      if [[ "$path" == *specs/*.html ]]; then
        $0 test "$path"
      fi
    done < <(inotifywait --quiet --monitor --event close_write -r specs/ -r main/ -r bin/) || exit 1
    $0 watch $THE_ARGS
    ;;

  test)
    mkdir -p /tmp/dum_dum_html
    TEMP="$(mktemp /tmp/dum_dum_html/tmp.XXXXXXXXX.template.html)"
    if [[ -z "$@" ]]; then
      $0 test specs/*.html
      exit 0
    fi

    for FILE in "$@"; do
      if [[ "$FILE" != *.template.html ]]; then
        continue
      fi

      split_on="$(cat "$FILE" -n | grep -i --extended-regexp '<!--\ +EXPECT.?\ +-->' | cut -f 1 | head -n 1)"
      expect="$(cat "$FILE" | tail -n +$((split_on + 1)))"

      cat "$FILE" | head -n $((split_on - 1)) > "$TEMP"
      actual="$($0 $TEMP)"
      if [[ "$actual" != "$expect" ]]; then
        echo -e "=== Failed: ${Red}${FILE}${Color_Off}" 1>&2
        diff <(echo "$actual") <(echo "$expect")
        exit 1
      fi

      echo -e "=== $Green$FILE$Reset"
    done
    ;;

  *)
    if [[ -f "$action" ]]; then
      node $THIS_DIR/main/main.js $THE_ARGS
      exit 0
    fi

    $action $THE_ARGS
    ;;

esac
